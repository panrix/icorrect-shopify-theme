{% comment %}
  ICORRECT MACBOOK WIZARD
  - Logic: Family -> Screen Size -> Chip/Year -> Pricing Table
  - Style: Apple-style step-by-step wizard
{% endcomment %}

{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}

{%- style -%}
  /* --- WRAPPER & LAYOUT --- */
  .ic-section {
    background: #fbfbfd;
    padding: 60px 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  
  .ic-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* --- HEADER & TRUST --- */
  .ic-header { text-align: center; margin-bottom: 50px; }
  .ic-title { font-size: 48px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 10px; color: #1d1d1f; }
  .ic-subtitle { font-size: 21px; color: #86868b; font-weight: 400; max-width: 700px; margin: 0 auto 30px; }

  .ic-trust-badges { display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; margin-top: 20px; }
  .ic-badge { 
    display: flex; align-items: center; gap: 8px; 
    background: #fff; padding: 10px 20px; border-radius: 30px; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.05); font-weight: 500; font-size: 14px; color: #333;
  }

  /* --- WIZARD CARD --- */
  .ic-wizard-container {
    background: #fff;
    border-radius: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.08);
    overflow: hidden;
    min-height: 500px;
    display: flex;
    flex-direction: column;
    position: relative;
    max-width: 900px;
    margin: 0 auto;
    border: 1px solid #d2d2d7;
  }

  /* WIZARD HEADER */
  .ic-wiz-nav {
    padding: 20px 30px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fafafa;
  }
  .ic-wiz-breadcrumbs { font-size: 14px; color: #86868b; font-weight: 500; }
  .ic-wiz-breadcrumbs span.active { color: #0071e3; }
  
  .ic-wiz-back {
    border: none; background: none; color: #0071e3; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; gap: 5px; opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .ic-wiz-back.visible { opacity: 1; pointer-events: auto; }

  /* WIZARD CONTENT AREA */
  .ic-wiz-content { padding: 40px; flex: 1; display: flex; flex-direction: column; align-items: center; }

  .ic-step { display: none; width: 100%; animation: fadeUp 0.4s ease-out; }
  .ic-step.active { display: block; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .ic-step-title { font-size: 28px; font-weight: 600; margin-bottom: 30px; text-align: center; color: #1d1d1f; }

  /* --- GRID OPTIONS --- */
  .ic-grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; width: 100%; justify-content: center; }
  .ic-grid-4 { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; width: 100%; }

  .ic-card-opt {
    border: 2px solid #edeff2; border-radius: 18px; padding: 30px 20px;
    cursor: pointer; text-align: center; transition: all 0.2s; background: #fff;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .ic-card-opt:hover { border-color: #0071e3; transform: scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
  
  /* Family Icons */
  .ic-fam-icon { height: 60px; margin-bottom: 20px; width: auto; object-fit: contain; }
  .ic-card-title { font-size: 18px; font-weight: 600; color: #1d1d1f; }
  
  /* Size/Year Buttons */
  .ic-btn-opt {
    min-width: 140px; padding: 18px;
    border: 2px solid #edeff2; border-radius: 12px; background: #fff;
    font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .ic-btn-opt:hover { border-color: #0071e3; color: #0071e3; background: #fbfbfd; }
  .ic-btn-opt span { display: block; font-size: 12px; color: #86868b; font-weight: 400; margin-top: 4px; }

  /* --- PRICING TABLE (RESULT) --- */
  .ic-result-container { width: 100%; max-width: 800px; margin: 0 auto; }
  
  .ic-model-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
  .ic-model-img { width: 100px; height: auto; }
  .ic-model-info h3 { margin: 0; font-size: 24px; }
  .ic-model-info p { margin: 5px 0 0; color: #666; }

  .ic-price-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
  .ic-price-table th { text-align: left; padding: 12px; color: #86868b; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #eee; }
  .ic-price-table td { padding: 20px 12px; border-bottom: 1px solid #f5f5f7; vertical-align: middle; }
  .ic-price-table tr:last-child td { border-bottom: none; }
  
  .ic-repair-type { font-weight: 600; font-size: 16px; display: block; }
  .ic-repair-meta { font-size: 13px; color: #86868b; }
  .ic-price-tag { font-weight: 700; font-size: 18px; color: #1d1d1f; }
  
  .ic-btn-book {
    background: #0071e3; color: #fff; text-decoration: none; padding: 8px 24px;
    border-radius: 20px; font-weight: 600; font-size: 14px; display: inline-block;
    transition: background 0.2s;
  }
  .ic-btn-book:hover { background: #0077ed; }

  .ic-cta-box {
    background: #f5f5f7; padding: 20px; border-radius: 12px; text-align: center; margin-top: 20px;
  }
  .ic-cta-link { color: #0071e3; font-weight: 600; text-decoration: none; }
  .ic-cta-link:hover { text-decoration: underline; }

  /* Mobile */
  @media (max-width: 768px) {
    .ic-title { font-size: 32px; }
    .ic-wiz-content { padding: 20px; }
    .ic-price-table th:nth-child(2), .ic-price-table td:nth-child(2) { display: none; } /* Hide time col on mobile */
    .ic-model-header { flex-direction: column; text-align: center; }
  }
{%- endstyle -%}

<div class="ic-section">
  <div class="ic-container">
    
    <div class="ic-header">
      <h1 class="ic-title">{{ section.settings.heading }}</h1>
      <p class="ic-subtitle">{{ section.settings.subheading }}</p>
      <div class="ic-trust-badges">
        <div class="ic-badge"><span>üõ°Ô∏è 2-Year Warranty</span></div>
        <div class="ic-badge"><span>‚ö° Same-Day Fix</span></div>
        <div class="ic-badge"><span>üçè Original Parts</span></div>
        <div class="ic-badge"><span>‚òÖ 4.9/5 Rating</span></div>
      </div>
    </div>

    <div class="ic-wizard-container" id="mac-wizard">
      
      <div class="ic-wiz-nav">
        <button class="ic-wiz-back" id="wiz-back">‚Üê Back</button>
        <div class="ic-wiz-breadcrumbs" id="wiz-crumbs">
          <span id="crumb-1" class="active">Family</span> ‚Ä∫ 
          <span id="crumb-2">Size</span> ‚Ä∫ 
          <span id="crumb-3">Model</span>
        </div>
      </div>

      <div class="ic-wiz-content">
        
        <div class="ic-step active" data-step="1">
          <div class="ic-step-title">Which MacBook do you have?</div>
          <div class="ic-grid-3">
            <div class="ic-card-opt" onclick="nextStep(1, 'Pro')">
              <img src="https://cdn.shopify.com/s/files/1/0728/7111/7053/files/macbook-pro.png?v=176608" class="ic-fam-icon" alt="Pro">
              <div class="ic-card-title">MacBook Pro</div>
            </div>
            <div class="ic-card-opt" onclick="nextStep(1, 'Air')">
              <img src="https://cdn.shopify.com/s/files/1/0728/7111/7053/files/macbook-air.png?v=176608" class="ic-fam-icon" alt="Air">
              <div class="ic-card-title">MacBook Air</div>
            </div>
            <div class="ic-card-opt" onclick="nextStep(1, 'MacBook')">
              <img src="https://cdn.shopify.com/s/files/1/0728/7111/7053/files/macbook-12.png?v=176608" class="ic-fam-icon" alt="MacBook">
              <div class="ic-card-title">MacBook (12")</div>
            </div>
          </div>
        </div>

        <div class="ic-step" data-step="2">
          <div class="ic-step-title">Select Screen Size</div>
          <div class="ic-grid-4" id="size-options-container">
            </div>
        </div>

        <div class="ic-step" data-step="3">
          <div class="ic-step-title">Select Year / Chip</div>
          <div class="ic-grid-4" id="model-options-container">
            </div>
        </div>

        <div class="ic-step" data-step="4">
          <div class="ic-result-container" id="result-content">
            </div>
          <div class="ic-cta-box">
             <p>Not the right model? <a href="#" onclick="restartWizard(); return false;" class="ic-cta-link">Start Over</a> or <a href="/pages/advanced-diagnostics" class="ic-cta-link">Book Diagnostic (¬£49)</a></p>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script>
  // 1. Build Data from Liquid Blocks
  const db = [
    {% for block in section.blocks %}
    {
      id: "{{ block.id }}",
      family: "{{ block.settings.family }}", // Pro, Air, MacBook
      size: "{{ block.settings.size }}", // 13, 14, 15, 16
      chip: "{{ block.settings.chip_year }}", // "M1 (2020)" or "2016-2019"
      title: "{{ block.settings.title }}",
      image: "{{ block.settings.image | img_url: '300x' }}",
      prices: {
        screen: "{{ block.settings.price_screen }}",
        battery: "{{ block.settings.price_battery }}",
        board: "{{ block.settings.price_board }}",
        keyboard: "{{ block.settings.price_keyboard }}"
      },
      products: {
        screen: "{{ block.settings.product_screen_id }}",
        battery: "{{ block.settings.product_battery_id }}",
        board: "{{ block.settings.product_board_id }}",
        keyboard: "{{ block.settings.product_keyboard_id }}"
      }
    },
    {% endfor %}
  ];

  // State Management
  let state = {
    step: 1,
    family: null,
    size: null,
    model: null
  };

  // DOM Elements
  const backBtn = document.getElementById('wiz-back');
  const crumbs = [
    document.getElementById('crumb-1'),
    document.getElementById('crumb-2'),
    document.getElementById('crumb-3')
  ];

  // Navigation Logic
  function nextStep(stepFrom, selection) {
    if (stepFrom === 1) {
      state.family = selection;
      renderSizeOptions();
    } else if (stepFrom === 2) {
      state.size = selection;
      renderModelOptions();
    } else if (stepFrom === 3) {
      // Selection is the entire model object
      renderResult(selection);
    }

    goToStep(stepFrom + 1);
  }

  function goToStep(stepNum) {
    state.step = stepNum;
    
    // UI Updates
    document.querySelectorAll('.ic-step').forEach(el => el.classList.remove('active'));
    document.querySelector(`.ic-step[data-step="${stepNum}"]`).classList.add('active');
    
    // Back Button
    if(stepNum > 1) backBtn.classList.add('visible');
    else backBtn.classList.remove('visible');

    // Breadcrumbs
    crumbs.forEach((c, index) => {
      if(index < stepNum) c.classList.add('active');
      else c.classList.remove('active');
    });
  }

  backBtn.onclick = function() {
    if(state.step > 1) {
      goToStep(state.step - 1);
    }
  };

  function restartWizard() {
    state = { step: 1, family: null, size: null, model: null };
    goToStep(1);
  }

  // Renderers
  function renderSizeOptions() {
    const container = document.getElementById('size-options-container');
    container.innerHTML = '';

    // Filter DB for selected family
    const familyModels = db.filter(m => m.family === state.family);
    
    // Get Unique Sizes
    const sizes = [...new Set(familyModels.map(item => item.size))].sort().reverse();

    if(sizes.length === 0) {
      container.innerHTML = '<p>No models found for this category.</p>';
      return;
    }

    sizes.forEach(size => {
      const btn = document.createElement('div');
      btn.className = 'ic-btn-opt';
      btn.innerHTML = `${size}-inch`;
      btn.onclick = () => nextStep(2, size);
      container.appendChild(btn);
    });
  }

  function renderModelOptions() {
    const container = document.getElementById('model-options-container');
    container.innerHTML = '';

    // Filter DB for Family + Size
    const matches = db.filter(m => m.family === state.family && m.size === state.size);

    matches.forEach(model => {
      const btn = document.createElement('div');
      btn.className = 'ic-btn-opt';
      // Store index or ID to retrieve later
      btn.innerHTML = `${model.chip} <span>${model.title}</span>`;
      btn.onclick = () => nextStep(3, model); // Pass full object
      container.appendChild(btn);
    });
  }

  function renderResult(model) {
    const container = document.getElementById('result-content');
    
    // Check if image exists
    const imgHtml = model.image ? `<img src="${model.image}" class="ic-model-img">` : '';

    let html = `
      <div class="ic-model-header">
        ${imgHtml}
        <div class="ic-model-info">
          <h3>${model.family} ${model.size}" Repair</h3>
          <p>${model.title} (${model.chip})</p>
        </div>
      </div>
      
      <table class="ic-price-table">
        <thead>
          <tr>
            <th>Service</th>
            <th>Time</th>
            <th>Warranty</th>
            <th>Price</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
    `;

    // Helper to add row
    const addRow = (name, meta, time, warranty, price, varId) => {
      if(!price || price === '') return;
      html += `
        <tr>
          <td>
            <span class="ic-repair-type">${name}</span>
            <span class="ic-repair-meta">${meta}</span>
          </td>
          <td>${time}</td>
          <td>${warranty}</td>
          <td class="ic-price-tag">${price}</td>
          <td style="text-align:right;">
            ${ varId ? `<a href="/cart/add?id=${varId}" class="ic-btn-book">Book</a>` : '<a href="/pages/contact" class="ic-btn-book">Enquire</a>' }
          </td>
        </tr>
      `;
    };

    addRow('Screen Replacement', 'Original Assembly', '2 Hrs', '2 Years', model.prices.screen, model.products.screen);
    addRow('Battery Service', 'Cycle Count Reset', '1 Hr', '2 Years', model.prices.battery, model.products.battery);
    addRow('Logic Board', 'Micro-soldering Repair', '3-5 Days', 'Lifetime', model.prices.board, model.products.board);
    addRow('Keyboard/Top Case', 'Full Assembly', '4 Hrs', '2 Years', model.prices.keyboard, model.products.keyboard);

    html += `</tbody></table>`;
    container.innerHTML = html;
  }
</script>

{% schema %}
{
  "name": "MacBook Repair Wizard",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "MacBook Repair Pricing" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Identify your model to see instant quotes." }
  ],
  "blocks": [
    {
      "type": "macbook_model",
      "name": "Model Config",
      "settings": [
        { "type": "text", "id": "title", "label": "Internal Name", "default": "MacBook Pro M1 2020" },
        { 
          "type": "select", "id": "family", "label": "Family", 
          "options": [
            { "value": "Pro", "label": "MacBook Pro" },
            { "value": "Air", "label": "MacBook Air" },
            { "value": "MacBook", "label": "MacBook (12-inch)" }
          ],
          "default": "Pro"
        },
        { 
          "type": "select", "id": "size", "label": "Screen Size", 
          "options": [
            { "value": "16", "label": "16-inch" },
            { "value": "15", "label": "15-inch" },
            { "value": "14", "label": "14-inch" },
            { "value": "13", "label": "13-inch" },
            { "value": "12", "label": "12-inch" }
          ],
          "default": "13"
        },
        { "type": "text", "id": "chip_year", "label": "Chip/Year Identifier", "default": "M1 (2020)", "info": "This is displayed on the button in Step 3" },
        { "type": "image_picker", "id": "image", "label": "Model Image" },
        
        { "type": "header", "content": "Pricing & Products" },
        
        { "type": "text", "id": "price_screen", "label": "Screen Price" },
        { "type": "product", "id": "product_screen_id", "label": "Screen Product" },
        
        { "type": "text", "id": "price_battery", "label": "Battery Price" },
        { "type": "product", "id": "product_battery_id", "label": "Battery Product" },
        
        { "type": "text", "id": "price_board", "label": "Board Price" },
        { "type": "product", "id": "product_board_id", "label": "Board Product" },
        
        { "type": "text", "id": "price_keyboard", "label": "Keyboard Price" },
        { "type": "product", "id": "product_keyboard_id", "label": "Keyboard Product" }
      ]
    }
  ],
  "presets": [
    { 
      "name": "MacBook Repair Wizard",
      "blocks": [
        {
          "type": "macbook_model",
          "settings": { "family": "Pro", "size": "13", "chip_year": "M1 (2020)", "price_screen": "¬£400", "price_battery": "¬£120" }
        },
        {
          "type": "macbook_model",
          "settings": { "family": "Pro", "size": "14", "chip_year": "M1 Pro/Max (2021)", "price_screen": "¬£550", "price_battery": "¬£140" }
        },
        {
          "type": "macbook_model",
          "settings": { "family": "Air", "size": "13", "chip_year": "M2 (2022)", "price_screen": "¬£450", "price_battery": "¬£130" }
        }
      ]
    }
  ]
}
{% endschema %}