<section class="icorrect-clean-section" id="icorrect-{{ section.id }}">
  <div class="page-width">
    
    <div class="ic-top-row">
      
      <div class="ic-text-col">
        <h2 class="ic-heading">{{ section.settings.heading }}</h2>
        <div class="ic-description">{{ section.settings.details }}</div>
      </div>

      <div class="ic-stats-col">
        
        <div class="ic-stat-card">
          <div class="stat-value" data-target="{{ section.settings.stat_1_num }}" data-type="integer">{{ section.settings.stat_1_num | append: '+' }}</div>
          <div class="stat-label">Devices Repaired</div>
        </div>

        <div class="ic-stat-card">
          <div class="stat-value" data-target="{{ section.settings.stat_2_num }}" data-type="float">{{ section.settings.stat_2_num }}</div>
          <div class="star-wrapper">
            <div class="stars-bg">★★★★★</div>
            <div class="stars-fill" data-rating="{{ section.settings.stat_2_num }}">★★★★★</div>
          </div>
          <div class="stat-label">Average Rating</div>
        </div>

        <div class="ic-stat-card">
          <div class="stat-value" data-target="{{ section.settings.stat_3_num }}" data-type="experience">{{ section.settings.stat_3_num }}+</div>
          <div class="stat-label">Years Experience</div>
        </div>

      </div>
    </div>

    <div class="ic-features-row">
      {% for block in section.blocks %}
        
      {% comment %} 
        LOGIC: FORCE the hardcoded URL for the first 6 items.
      {% endcomment %}
      
      {% assign icon_src = '' %}
      
      {% case forloop.index %}
        {% when 1 %}{% assign icon_src = 'https://cdn.shopify.com/s/files/1/0728/7111/7053/files/original_1.png?v=1766156630' %}
        {% when 2 %}{% assign icon_src = 'https://cdn.shopify.com/s/files/1/0728/7111/7053/files/processor.png?v=1766156630' %}
        {% when 3 %}{% assign icon_src = 'https://cdn.shopify.com/s/files/1/0728/7111/7053/files/support.png?v=1766156630' %}
        {% when 4 %}{% assign icon_src = 'https://cdn.shopify.com/s/files/1/0728/7111/7053/files/recycle.png?v=1766156630' %}
        {% when 5 %}{% assign icon_src = 'https://cdn.shopify.com/s/files/1/0728/7111/7053/files/pioneer.png?v=1766156630' %}
        {% when 6 %}{% assign icon_src = 'https://cdn.shopify.com/s/files/1/0728/7111/7053/files/review_1.png?v=1766156630' %}
      {% endcase %}

      {% comment %} Fallback to user upload if it's a 7th block or above {% endcomment %}
      {% if icon_src == blank and block.settings.icon != blank %}
        {% assign icon_src = block.settings.icon | img_url: '120x' %}
      {% endif %}

      <div class="ic-feature-item">
        <div class="ic-icon-wrapper">
          {% if icon_src != blank %}
            <img src="{{ icon_src }}" alt="{{ block.settings.info }}" loading="lazy">
          {% else %}
             <div class="ic-placeholder-icon"></div>
          {% endif %}
        </div>
        <span class="ic-feature-text">{{ block.settings.info }}</span>
      </div>
      {% endfor %}
    </div>

  </div>
</section>

<style>
  /* --- SECTION BASE --- */
  #icorrect-{{ section.id }} {
    padding-top: {{ section.settings.padding-top }}px;
    padding-bottom: {{ section.settings.padding-bottom }}px;
    background-color: {{ section.settings.bg_color }};
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: #1D1D1F;
  }

  /* --- TOP ROW LAYOUT --- */
  .ic-top-row {
    display: flex;
    justify-content: space-between;
    align-items: center; 
    gap: 60px;
    margin-bottom: 80px;
  }

  /* --- LEFT COLUMN (TEXT) --- */
  .ic-text-col {
    flex: 1;
    max-width: 450px;
  }

  .ic-heading {
    font-size: 40px;
    font-weight: 600;
    line-height: 1.1;
    margin-bottom: 20px;
    color: #1D1D1F;
    letter-spacing: -0.02em;
  }

  .ic-description p {
    font-size: 16px;
    line-height: 1.6;
    color: #424245;
    margin: 0;
  }

  /* --- RIGHT COLUMN (STATS) --- */
  .ic-stats-col {
    flex: 1.2;
    display: flex;
    justify-content: space-between;
    gap: 20px;
  }

  .ic-stat-card {
    text-align: center;
    flex: 1;
    background: #F5F5F7; /* Darker White (Apple Grey) */
    padding: 30px 15px;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.02); 
    border: 1px solid rgba(0,0,0,0.02);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-width: 140px;
    transition: transform 0.3s ease;
  }
  
  .ic-stat-card:hover {
    transform: translateY(-5px);
  }

  .stat-value {
    font-size: 38px;
    font-weight: 700;
    color: #1D1D1F;
    line-height: 1.2;
    margin-bottom: 5px;
    font-variant-numeric: tabular-nums;
  }

  .stat-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    color: #86868B;
    letter-spacing: 0.05em;
    margin-top: 10px;
  }

  /* --- STAR ANIMATION --- */
  .star-wrapper {
    position: relative;
    display: inline-block;
    font-size: 18px;
    line-height: 1;
    margin: 8px 0 2px 0;
  }

  .stars-bg {
    color: #D1D1D6; 
  }

  .stars-fill {
    position: absolute;
    top: 0;
    left: 0;
    white-space: nowrap;
    overflow: hidden;
    color: #F5A623; 
    width: 0%; 
    transition: width 2.5s cubic-bezier(0.25, 1, 0.5, 1);
  }

  /* --- BOTTOM ROW (FEATURES) --- */
  .ic-features-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr); 
    row-gap: 40px;
    column-gap: 20px;
    padding-top: 50px;
    border-top: 1px solid #E5E5E5;
  }

  .ic-feature-item {
    display: flex;
    flex-direction: row; 
    align-items: center; 
    justify-content: center; 
    gap: 15px;
    text-align: left;
  }

  .ic-icon-wrapper {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0; 
  }

  .ic-icon-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .ic-feature-text {
    font-size: 16px;
    font-weight: 600;
    color: #1D1D1F;
    line-height: 1.3;
  }

  .ic-placeholder-icon {
    width: 40px; 
    height: 40px; 
    background: #eee; 
    border-radius: 50%;
  }

  /* --- RESPONSIVE --- */
  @media(max-width: 900px) {
    #icorrect-{{ section.id }} {
      padding-top: {{ section.settings.mob-padding-top }}px;
      padding-bottom: {{ section.settings.mob-padding-bottom }}px;
    }

    .ic-top-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 40px;
      margin-bottom: 50px;
    }

    .ic-text-col {
      max-width: 100%;
    }

    .ic-heading {
      font-size: 32px;
    }

    .ic-stats-col {
      width: 100%;
      gap: 15px;
      flex-wrap: wrap; 
    }

    .ic-stat-card {
      min-width: 100%; 
      display: flex;
      flex-direction: row; 
      justify-content: space-between;
      padding: 20px 30px;
      text-align: left;
      align-items: center;
    }
    
    .ic-stat-card .stat-label {
        margin-top: 0;
        text-align: right;
    }
    
    .ic-stat-card .stat-value {
        margin-bottom: 0;
    }

    .ic-features-row {
      grid-template-columns: 1fr; /* 1 column stack on mobile */
      gap: 30px;
    }
    
    .ic-feature-item {
      justify-content: flex-start; /* Left align on mobile */
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const section = document.getElementById('icorrect-{{ section.id }}');
  if (!section) return;

  // Select the STATS container specifically, not the whole section
  const statsContainer = section.querySelector('.ic-stats-col');

  // rootMargin: -50px means "Don't trigger until the element is 50px UP into the viewport"
  // This prevents it from triggering if the user just barely scrolls it into view at the very bottom
  const observerOptions = { 
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px' 
  }; 

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        runAnimations(entry.target);
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  if(statsContainer) {
    observer.observe(statsContainer);
  } else {
    // Fallback if container not found
    observer.observe(section);
  }

  function runAnimations(container) {
    const stats = container.querySelectorAll('.stat-value');
    
    stats.forEach(stat => {
      const type = stat.getAttribute('data-type');
      const target = parseFloat(stat.getAttribute('data-target'));
      
      // CONFIGURATION
      let duration = 2000; 
      if (type === 'float') duration = 2500; 
      
      const start = 0;
      const startTime = performance.now();

      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);
        
        const currentVal = start + (target - start) * ease;

        if (type === 'integer') {
          stat.textContent = Math.floor(currentVal).toLocaleString() + "+";
        } 
        else if (type === 'float') {
          stat.textContent = currentVal.toFixed(1) + "/5";
          const starFill = stat.nextElementSibling.querySelector('.stars-fill');
          if(starFill) {
            const percentage = (currentVal / 5) * 100;
            starFill.style.width = `${percentage}%`;
          }
        } 
        else if (type === 'experience') {
          const val = Math.floor(currentVal);
          if (progress >= 1) stat.textContent = val + "+";
          else stat.textContent = val;
        }

        if (progress < 1) {
          requestAnimationFrame(update);
        } else {
          if (type === 'integer') stat.textContent = target.toLocaleString() + "+";
          if (type === 'float') stat.textContent = target.toFixed(1) + "/5";
          if (type === 'experience') stat.textContent = target + "+";
        }
      }

      requestAnimationFrame(update);
    });
  }
});
</script>

{% schema %}
  {
    "name": "Why iCorrect (Scroll)",
    "settings": [
      {
         "type": "color",
         "id": "bg_color",
         "label": "Section Background Color",
         "default": "#FFFFFF"
       },
      {
         "type": "range",
         "id": "padding-top",
         "label": "Top Padding",
         "default": 80,
         "min": 0,
         "max": 100,
         "step": 5,
         "unit": "px"
       },
       {
         "type": "range",
         "id": "padding-bottom",
         "label": "Bottom Padding",
         "default": 80,
         "min": 0,
         "max": 100,
         "step": 5,
         "unit": "px"
       },
       {
         "type": "range",
         "id": "mob-padding-top",
         "label": "Mobile Top Padding",
         "default": 40,
         "min": 0,
         "max": 100,
         "step": 5,
         "unit": "px"
       },
       {
         "type": "range",
         "id": "mob-padding-bottom",
         "label": "Mobile Bottom Padding",
         "default": 40,
         "min": 0,
         "max": 100,
         "step": 5,
         "unit": "px"
       },
       {
         "type": "text",
         "id": "heading",
         "label": "Heading",
         "default": "Why iCorrect?"
       },
       {
         "type": "richtext",
         "id": "details",
         "label": "Details",
         "default": "<p>At iCorrect, our repairs are completed using original parts which are sustainably sourced. We are a team of Apple microelectronic specialists who understand and repair to microchip level.</p>"
       },
       {
         "type": "header",
         "content": "Stats Settings"
       },
       {
         "type": "text",
         "id": "stat_1_num",
         "label": "Devices Repaired (Number)",
         "default": "250000"
       },
       {
         "type": "text",
         "id": "stat_2_num",
         "label": "Average Rating (Out of 5)",
         "default": "4.8"
       },
       {
         "type": "text",
         "id": "stat_3_num",
         "label": "Years Experience (Number)",
         "default": "10+"
       }
    ],
  "blocks":[
      {
        "type":"info",
        "name":"Feature Icon",
        "settings":[
            {
               "type":"image_picker",
               "id":"icon",
               "label":"Select Icon (Optional - Auto-filled for first 6)"
            },
            {
               "type": "text",
               "id": "info",
               "label": "Feature Text",
               "default": "Feature Name"
            }
         ]
      }
  ],
  "presets": [
    {
      "name": "Why iCorrect (Scroll)", 
      "category": "section",
      "blocks": [
        { "type": "info", "settings": { "info": "Original Parts Used" } },
        { "type": "info", "settings": { "info": "Microelectronic Specialists" } },
        { "type": "info", "settings": { "info": "Expert Fault Finders" } },
        { "type": "info", "settings": { "info": "Sustainable Repairs" } },
        { "type": "info", "settings": { "info": "Pioneering Repair Solutions" } },
        { "type": "info", "settings": { "info": "Near 0 Return Rate" } }
      ]
    }
  ]
}
{% endschema %}